"use strict";(self.webpackChunkjakarta_subway=self.webpackChunkjakarta_subway||[]).push([[33956],{46533(e,t,i){i.d(t,{CW:()=>h,DE:()=>f,GA:()=>v,S1:()=>p,pH:()=>y});var r=i(89379),n=i(81806),a=i(76460),s=i(15941),l=i(50346),o=i(47249),u=i(76797),d=i(80963);const c=()=>a.A.getLogger("esri.views.2d.engine.flow.dataUtils");async function h(e,t,i,r){const a=performance.now(),s=f(t,i),u=performance.now(),d=p(t,s,i.width,i.height),h=performance.now(),g=function(e,t){const i=new o.A,r=e.reduce((e,t)=>e+t.vertices.length,0),n=new Float32Array(4*r),a=new Array(e.length);let s=0,l=0;for(const{vertices:o}of e){const e=s;for(const t of o)n[4*s]=t.x,n[4*s+1]=t.y,n[4*s+2]=t.t,n[4*s+3]=t.speed,s++;a[l++]={startVertex:e,numberOfVertices:o.length,totalTime:o[o.length-1].t,timeSeed:t?i.getFloat():0}}return{lineVertices:n,lineDescriptors:a}}(d,!0),m=performance.now(),v="Streamlines"===e?function(e,t){const i=9,{lineVertices:r,lineDescriptors:n}=e;let a=0,s=0;for(const f of n)a+=2*f.numberOfVertices,s+=6*(f.numberOfVertices-1);const l=new Float32Array(a*i),o=new Uint32Array(s);let u=0,d=0;function c(){o[d++]=u-2,o[d++]=u,o[d++]=u-1,o[d++]=u,o[d++]=u+1,o[d++]=u-1}function h(e,t,r,n,a,s,o,d){const c=u*i;let h=0;l[c+h++]=e,l[c+h++]=t,l[c+h++]=1,l[c+h++]=r,l[c+h++]=s,l[c+h++]=o,l[c+h++]=n/2,l[c+h++]=a/2,l[c+h++]=d,u++,l[c+h++]=e,l[c+h++]=t,l[c+h++]=-1,l[c+h++]=r,l[c+h++]=s,l[c+h++]=o,l[c+h++]=-n/2,l[c+h++]=-a/2,l[c+h++]=d,u++}for(const f of n){const{totalTime:e,timeSeed:i}=f;let n=null,a=null,s=null,l=null,o=null,u=null;for(let d=0;d<f.numberOfVertices;d++){const g=r[4*(f.startVertex+d)],m=r[4*(f.startVertex+d)+1],p=r[4*(f.startVertex+d)+2],v=r[4*(f.startVertex+d)+3];let y=null,_=null,w=null,T=null;if(d>0){y=g-n,_=m-a;const r=Math.sqrt(y*y+_*_);if(y/=r,_/=r,d>1){let e=y+o,i=_+u;const r=Math.sqrt(e*e+i*i);e/=r,i/=r;const n=Math.min(1/(e*y+i*_),t);e*=n,i*=n,w=-i,T=e}else w=-_,T=y;null!==w&&null!==T&&(h(n,a,s,w,T,e,i,v),c())}n=g,a=m,s=p,o=y,u=_,l=v}h(n,a,s,-u,o,e,i,l)}return{vertexData:l,indexData:o}}(g,10):function(e){const t=16,i=1,r=2,{lineVertices:n,lineDescriptors:a}=e;let s=0,l=0;for(const L of a){const e=L.numberOfVertices-1;s+=4*e*2,l+=6*e*2}const o=new Float32Array(s*t),u=new Uint32Array(l);let d,c,h,f,g,m,p,v,y,_,w,T,M,x,S=0,b=0;function A(){u[b++]=S-8,u[b++]=S-7,u[b++]=S-6,u[b++]=S-7,u[b++]=S-5,u[b++]=S-6,u[b++]=S-4,u[b++]=S-3,u[b++]=S-2,u[b++]=S-3,u[b++]=S-1,u[b++]=S-2}function R(e,n,a,s,l,u,d,c,h,f,g,m,p,v){const y=S*t;let _=0;for(const t of[i,r])for(const i of[1,2,3,4])o[y+_++]=e,o[y+_++]=n,o[y+_++]=a,o[y+_++]=s,o[y+_++]=d,o[y+_++]=c,o[y+_++]=h,o[y+_++]=f,o[y+_++]=t,o[y+_++]=i,o[y+_++]=p,o[y+_++]=v,o[y+_++]=l/2,o[y+_++]=u/2,o[y+_++]=g/2,o[y+_++]=m/2,S++}function C(e,t){let i=y+w,r=_+T;const n=Math.sqrt(i*i+r*r);i/=n,r/=n;const a=y*i+_*r;i/=a,r/=a;let s=w+M,l=T+x;const o=Math.sqrt(s*s+l*l);s/=o,l/=o;const u=w*s+T*l;s/=u,l/=u,R(d,c,h,f,-r,i,g,m,p,v,-l,s,e,t),A()}function V(e,t,i,r,n,a){if(y=w,_=T,w=M,T=x,null==y&&null==_&&(y=w,_=T),null!=g&&null!=m){M=e-g,x=t-m;const i=Math.sqrt(M*M+x*x);M/=i,x/=i}null!=y&&null!=_&&C(n,a),d=g,c=m,h=p,f=v,g=e,m=t,p=i,v=r}function P(e,t){y=w,_=T,w=M,T=x,null==y&&null==_&&(y=w,_=T),null!=y&&null!=_&&C(e,t)}for(const L of a){d=null,c=null,h=null,f=null,g=null,m=null,p=null,v=null,y=null,_=null,w=null,T=null,M=null,x=null;const{totalTime:e,timeSeed:t}=L;for(let i=0;i<L.numberOfVertices;i++)V(n[4*(L.startVertex+i)],n[4*(L.startVertex+i)+1],n[4*(L.startVertex+i)+2],n[4*(L.startVertex+i)+3],e,t);P(e,t)}return{vertexData:o,indexData:u}}(g),y=performance.now();return(0,n.A)("esri-2d-profiler")&&(c().info("I.1","_createFlowFieldFromData (ms)",Math.round(u-a)),c().info("I.2","_getStreamlines (ms)",Math.round(h-u)),c().info("I.3","createAnimatedLinesData (ms)",Math.round(m-h)),c().info("I.4","create{Streamlines|Particles}Mesh (ms)",Math.round(y-m)),c().info("I.5","createFlowMesh (ms)",Math.round(y-a)),c().info("I.6","Mesh size (bytes)",v.vertexData.buffer.byteLength+v.indexData.buffer.byteLength)),await Promise.resolve(),(0,l.Te)(r),v}function f(e,t){const i=function(e,t,i,r){if(0===r)return e;const n=Math.round(3*r),a=new Array(2*n+1);let s=0;for(let u=-n;u<=n;u++){const e=Math.exp(-u*u/(r*r));a[u+n]=e,s+=e}for(let u=-n;u<=n;u++)a[u+n]/=s;const l=new Float32Array(e.length);for(let u=0;u<i;u++)for(let i=0;i<t;i++){let r=0,s=0;for(let l=-n;l<=n;l++){if(i+l<0||i+l>=t)continue;const o=a[l+n];r+=o*e[2*(u*t+(i+l))],s+=o*e[2*(u*t+(i+l))+1]}l[2*(u*t+i)]=r,l[2*(u*t+i)+1]=s}const o=new Float32Array(e.length);for(let u=0;u<t;u++)for(let e=0;e<i;e++){let r=0,s=0;for(let o=-n;o<=n;o++){if(e+o<0||e+o>=i)continue;const d=a[o+n];r+=d*l[2*((e+o)*t+u)],s+=d*l[2*((e+o)*t+u)+1]}o[2*(e*t+u)]=r,o[2*(e*t+u)+1]=s}return o}(t.data,t.width,t.height,e.smoothing);return e.interpolate?(e,r)=>{const n=Math.floor(e),a=Math.floor(r);if(n<0||n>=t.width)return[0,0];if(a<0||a>=t.height)return[0,0];const s=e-n,l=r-a,o=n,u=a,d=n<t.width-1?n+1:n,c=a<t.height-1?a+1:a,h=i[2*(u*t.width+o)],f=i[2*(u*t.width+d)],g=i[2*(c*t.width+o)],m=i[2*(c*t.width+d)],p=i[2*(u*t.width+o)+1],v=i[2*(u*t.width+d)+1];return[(h*(1-l)+g*l)*(1-s)+(f*(1-l)+m*l)*s,(p*(1-l)+i[2*(c*t.width+o)+1]*l)*(1-s)+(v*(1-l)+i[2*(c*t.width+d)+1]*l)*s]}:(e,r)=>{const n=Math.round(e),a=Math.round(r);return n<0||n>=t.width||a<0||a>=t.height?[0,0]:[i[2*(a*t.width+n)],i[2*(a*t.width+n)+1]]}}function g(e,t,i,r,n,a,l,o){const u=[],{raster:d,width:c,height:h,resolutionFactor:f}=o;let g=r,m=n,p=0,[v,y]=i(g,m);v*=t.velocityScale,y*=t.velocityScale;const _=Math.sqrt(v*v+y*y);let w,T;u.push({x:g,y:m,t:p,speed:_});for(let M=0;M<t.verticesPerLine;M++){let[r,n]=i(g,m);r*=t.velocityScale,n*=t.velocityScale;const o=Math.sqrt(r*r+n*n);if(o<t.minSpeedThreshold)return u;const v=e*r/o,y=e*n/o;if(g+=v*t.segmentLength,m+=y*t.segmentLength,t.wrapAround&&(g=(0,s.OS)(g,a[0])),p+=e*t.segmentLength/o,Math.acos(v*w+y*T)>t.maxTurnAngle)return u;if(t.collisions){let e=Math.round(g*f);const i=Math.round(m*f);if(t.wrapAround&&(e=(0,s.OS)(e,c)),e<0||e>c-1||i<0||i>h-1)return u;const r=d[i*c+e];if(-1!==r&&r!==l)return u;d[i*c+e]=l}u.push({x:g,y:m,t:p,speed:o}),w=v,T=y}return u}function m(e,t,i,n,a,s,l,o){const u=Math.round((.2+.6*l.getFloat())*e.verticesPerLine),d=e.verticesPerLine-u,c=g(-1,(0,r.A)((0,r.A)({},e),{},{verticesPerLine:d}),t,i,n,a,s,o),h=g(1,(0,r.A)((0,r.A)({},e),{},{verticesPerLine:u}),t,i,n,a,s,o),f=c.reverse();return f.splice(-1,1),f.concat(h)}function p(e,t,i,r){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{positions:[]};if(e.density<=0)return[];const{positions:a}=n,s=[],l=new o.A,u=1/Math.max(e.lineCollisionWidth,1),d=Math.round(i*u),c=Math.round(r*u),h=new Int32Array(d*c);for(let o=0;o<h.length;o++)h[o]=-1;const f={raster:h,width:d,height:c,resolutionFactor:u},p={},v=e.lineSpacing/Math.sqrt(e.density),y=Math.floor(r/v),_=Math.floor(i/v);for(let o=0;o<y;o++){const e=o*v;for(let t=0;t<_;t++){const i=t*v;p["".concat(t,"-").concat(o)]={x:i,y:e,positions:[]}}}for(const{x:o,y:g}of a){const e=p["".concat(Math.floor(o/v),"-").concat(Math.floor(g/v))];e&&e.positions.push([o,g])}const w=[];for(const o in p){const e=p[o];if(0===e.positions.length)w.push({x:e.x+v/2,y:e.y+v/2,sort:.66+.33*l.getFloat(),stage:0});else{const[t]=e.positions.splice(0,1);w.push({x:t[0],y:t[1],sort:.33*l.getFloat(),stage:1});for(const[i,r]of e.positions)w.push({x:i,y:r,sort:.33+.33*l.getFloat(),stage:2})}}w.sort((e,t)=>e.sort-t.sort);for(const{x:o,y:T,stage:M}of w){const n=e.onlyForwardTracing?g(1,e,t,o,T,[i,r],s.length,f):m(e,t,o,T,[i,r],s.length,l,f);n.length<2||s.push({stage:M,vertices:n})}return s}function v(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.width,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.height,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;const l=t.pixels,o=i*r,u=new Float32Array(2*o),d=t.width,c=(e,t)=>e+n+(t+a)*d,h=(e,t)=>e+t*i;let f;if(null!=t.mask)if(i!==t.width||r!==t.height||0!==n||0!==a){f=new Uint8Array(2*o);const e=t.mask;for(let t=0;t<r;++t)for(let r=0;r<i;++r){const i=c(r,t),n=h(r,t);f[2*n]=e[2*i],f[2*n+1]=e[2*i+1]}}else f=t.mask;else f=new Uint8Array(2*o),f.fill(255);if("vector-uv"===e)for(let s=0;s<r;++s)for(let e=0;e<i;++e){const t=c(e,s),i=h(e,s);u[2*i]=l[0][t],u[2*i+1]=-l[1][t]}else if("vector-magdir"===e){const{cos:e,sin:t}=Math;for(let n=0;n<r;++n)for(let r=0;r<i;++r){const i=c(r,n),a=h(r,n),o=l[0][i],d=(0,s.kU)(l[1][i]),f=e(d-Math.PI/2),g=t(d-Math.PI/2);u[2*a]=f*o,u[2*a+1]=g*o}}return{data:u,mask:f,width:i,height:r}}async function y(e,t,i,r,a,s){const l=performance.now(),o=(0,d.Vp)(t.spatialReference);if(!o){const o=await _(e,t,i,r,a,s);return(0,n.A)("esri-2d-profiler")&&c().info("I.7","loadImagery, early exit (ms)",Math.round(performance.now()-l)),(0,n.A)("esri-2d-profiler")&&c().info("I.9","Number of parts",1),o}const[h,f]=o.valid,g=f-h,m=Math.ceil(t.width/g),p=t.width/m,v=Math.round(i/m);let y=t.xmin;const w=[],T=performance.now();for(let n=0;n<m;n++){const i=new u.A({xmin:y,xmax:y+p,ymin:t.ymin,ymax:t.ymax,spatialReference:t.spatialReference});w.push(_(e,i,v,r,a,s)),y+=p}const M=await Promise.all(w);if((0,n.A)("esri-2d-profiler")&&c().info("I.8","All calls to _fetchPart (ms)",Math.round(performance.now()-T)),(0,n.A)("esri-2d-profiler")&&c().info("I.9","Number of parts",M.length),1===M.length)return(0,n.A)("esri-2d-profiler")&&c().info("I.10","loadImagery, general exit without stitching back (ms)",Math.round(performance.now()-l)),M[0];const x={data:new Float32Array(i*r*2),mask:new Uint8Array(i*r),width:i,height:r};let S=0;for(const n of M){for(let e=0;e<n.height;e++)for(let t=0;t<n.width;t++)S+t>=i||(x.data[2*(e*i+S+t)]=n.data[2*(e*n.width+t)],x.data[2*(e*i+S+t)+1]=n.data[2*(e*n.width+t)+1],x.mask[e*i+S+t]=n.mask[e*n.width+t]);S+=n.width}return(0,n.A)("esri-2d-profiler")&&c().info("I.10","loadImagery, general exit (ms)",Math.round(performance.now()-l)),x}async function _(e,t,i,r,n,a){const s={requestProjectedLocalDirections:!0,signal:a};if(null!=n&&(s.timeExtent=n),"imagery"===e.type){var l;await e.load({signal:a});const n=await e.internalFetchImage(t,i,r,s);return null==(null===n||void 0===n||null===(l=n.pixelData)||void 0===l?void 0:l.pixelBlock)?{data:new Float32Array(i*r*2),mask:new Uint8Array(i*r),width:i,height:r}:v(e.rasterInfo.dataType,n.pixelData.pixelBlock)}await e.load({signal:a});const o=await e.fetchPixels(t,i,r,s);return null==(null===o||void 0===o?void 0:o.pixelBlock)?{data:new Float32Array(i*r*2),mask:new Uint8Array(i*r),width:i,height:r}:v(e.serviceRasterInfo.dataType,o.pixelBlock)}},51939(e,t,i){i.d(t,{AL:()=>y,DV:()=>m,ER:()=>n,F_:()=>l,Nd:()=>f,Oo:()=>a,dy:()=>h,eS:()=>M,h4:()=>x,jC:()=>v,nq:()=>g,rZ:()=>c,y6:()=>p});var r=i(44135);const n="Raster.",a="Raster.Dim.",s=".Max",l={servicePixelValue:"Raster.ServicePixelValue",rawServicePixelValue:"Raster.ServicePixelValue.Raw",itemPixelValue:"Raster.ItemPixelValue",magnitude:"Raster.Magnitude",direction:"Raster.Direction",variable:"Raster.Variable"},o=new Map([["quarters","Quarter"],["months","Month"],["weeks","Week of the year"],["days","Day of the year"]]);function u(e,t){return new r.A({name:e,alias:t,domain:null,editable:!1,length:50,type:"string"})}function d(e,t){return new r.A({name:e,alias:t,domain:null,editable:!1,type:"double"})}function c(e){return u(l.servicePixelValue,null!==e&&void 0!==e?e:"Service Pixel Value")}function h(e){return u(l.rawServicePixelValue,null!==e&&void 0!==e?e:"Raw Service Pixel Value")}function f(){return u(l.itemPixelValue,"Item Pixel Value")}function g(e){return u("".concat(l.servicePixelValue,".").concat(e),e)}function m(e){return d("".concat(l.magnitude),"Magnitude"+(e?" (".concat(e,")"):""))}function p(){return d("".concat(l.direction),"Direction (\xb0)")}function v(e){return e.fields.filter(e=>"oid"!==e.type&&"value"!==e.name.toLowerCase()).map(e=>{const t=e.clone();return t.name="".concat(n).concat(e.name),t})}function y(e){const t=new Set,i=new Set,n=new Map;return e.variables.forEach(e=>{let{dimensions:r}=e;r.forEach(e=>{if(e.recurring)n.set(e.name,e.unit);else{var r,a;const n="ISO8601"===(null===(r=e.unit)||void 0===r?void 0:r.trim())||"stdtime"===(null===(a=e.name)||void 0===a||null===(a=a.trim())||void 0===a?void 0:a.toLowerCase())?t:i;n.add(e.name),e.hasRanges&&n.add("".concat(e.name).concat(s))}})}),[u(l.variable,"Variable"),...[...t].map(e=>function(e,t){return new r.A({name:e,alias:t,domain:null,editable:!1,type:"date"})}("".concat(a).concat(e),w(e))),...[...i].map(e=>d("".concat(a).concat(e),w(e))),...[...n].map(e=>{let[t,i]=e;return d("".concat(a).concat(t),_(t,i))})]}function _(e,t){var i;return(t=null===(i=t)||void 0===i?void 0:i.toLowerCase())&&o.has(t)?o.get(t):w(e)}function w(e){const t=e.endsWith(s),i=t?e.slice(0,-4):e,r="StdTime"===i?"Standard Time":"StdZ"===i?"Standard Z":i;return t?"".concat(r," Max"):r}function T(e,t){return t?new Date(e):e}function M(e,t,i){(null===i||void 0===i?void 0:i.length)&&(t[l.variable]=i[0].variableName,i.forEach(i=>{let{dimensionName:r,values:n}=i;if(r&&null!==n&&void 0!==n&&n.length){const i="".concat(a).concat(r),l=e.find(e=>{let{name:t}=e;return t===i});if(!l)return;const o="date"===l.type,u=n[0];if(Array.isArray(u)){if(t["".concat(a).concat(r)]=T(u[0],o),null!=u[1]){const i="".concat(a).concat(r).concat(s);if(e.some(e=>{let{name:t}=e;return t===i})){const e=T(u[1],o);t[i]=e}}}else t["".concat(a).concat(r)]=T(u,o)}}))}function x(e,t){if(t.pixelType.startsWith("f")&&e.forEach(e=>{let{format:t,fieldName:i}=e;t&&i&&/^raster\.(item|service)pixelvalue/i.test(i)&&(t.places=2)}),t.multidimensionalInfo){const i=t.multidimensionalInfo.variables.flatMap(e=>{let{dimensions:t}=e;return t});e.forEach(e=>{let{format:t,fieldName:r}=e;if(t&&null!==r&&void 0!==r&&r.startsWith(a)){var n;const e=r.slice(a.length),l="".concat(e).concat(s),o=i.find(t=>{let{name:i}=t;return i===e||i===l});(null===o||void 0===o||null===(n=o.values)||void 0===n?void 0:n.every(e=>Number.isInteger(e)))&&(t.places=0)}})}}},64147(e,t,i){i.d(t,{$7:()=>u,Ci:()=>g,Cq:()=>m,FO:()=>d,NK:()=>h,S$:()=>r,iM:()=>f,jt:()=>a,nD:()=>o,q6:()=>s,q7:()=>l,ti:()=>c,um:()=>n});const r=.1,n=1,a=1,s=1e3,l=!1,o=3,u=1,d=1.5,c=501,h=256,f=3,g=2,m=2},89214(e,t,i){i.d(t,{A:()=>Y});var r=i(89379),n=i(6326),a=i(18690),s=(i(81806),i(30726)),l=i(50346),o=i(68134),u=i(52394),d=i(91417),c=i(31633),h=i(46053),f=(i(76460),i(87990)),g=i(34111),m=i(56611),p=i(2413),v=i(80963),y=i(731),_=i(66917),w=i(69576),T=i(1873),M=i(64147),x=i(3109),S=i(12016);class b extends S.B{constructor(e){super("FlowWorker","generateStreamlines",{generateStreamlines:e=>[e.flowData.data.buffer,e.flowData.mask.buffer],generateTiledStreamlines:e=>{const t=[];return e.flowDataTiles.forEach(e=>{"loaded"===e.type&&t.push(e.data.data.buffer,e.data.mask.buffer)}),t}},e,{strategy:"dedicated"})}generateStreamlines(e,t){return this.invokeMethod("generateStreamlines",e,t)}generateTiledStreamlines(e,t){return this.invokeMethod("generateTiledStreamlines",e,t)}}var A=i(69539),R=i(9392),C=i(75002),V=i(94587),P=i(12482),L=i(63048),k=i(70667),D=i(31723),I=i(1599);function F(e,t,i,r,n,a){let{vertices:s,stage:l,hasMagnitude:o}=i;const{spatialReference:u}=t.extent,d=[],c=(0,D.uu)(o),h=t.flowExtentInfo.modelSize[0];let f=0;for(let x=0;x<s.length;x+=c){if(a&&x>0){const e=s[x]-s[x-c];e>h/2?f-=h:-e>h/2&&(f+=h)}const[i,n]=t.modelToMapSpace(s[x]+f,s[x+1],!1),l=a?[i,n,I.bi]:q(i,n,u,e,r);d.push(l)}const g=Math.floor(s.length/c),m=(0,V.fY)(g);for(let x=0;x<g;x++)m[x]=s[x*c+2];const{hasVVColor:p,hasVVOpacity:v,hasVVSize:y}=n.parameters;let _,w,T;if(o&&(p||v||y)){const e=(0,C.oe)(g);for(let t=0;t<g;t++)e[t]=s[t*c+3];p&&(_=[e]),v&&(w=[e]),y&&(T=[e])}const M=(0,k.yU)([d],void 0,[{timeStamps:m,streamlineType:l}],_,w,T);return(0,k.te)(n,M[0])}function q(e,t,i,r,n){const{absoluteZ:a}=(0,P.Q5)(e,t,0,i,r,n),s=(0,R.fA)(e,t,a);return r.renderCoordsHelper.toRenderCoords(s,i,s),s}var Z=i(10600),E=i(48989),O=i(97255);class G{constructor(e,t,i,r,n){this._query=e,this.streamlines=t,this._material=i,this.geometries=r,this._bytesPerFeature=n,this._startTime=0,this._endTime=1/0,this.usedMemory=null,this.startTime=this._query.time,this.computeMemory()}computeMemory(){const e=(0,O.Qh)(this.streamlines),t=(0,O.Qh)(this.geometries.map(e=>e.attributes)),i=this.streamlines.length*this._bytesPerFeature;this.usedMemory=e+t+i}get startTime(){return this._startTime}set startTime(e){this._query.time!==e&&(this._query=new x.y6(this._query.extent,this._query.timeExtent,this._query.size,this._query.pixelRatio,(0,d.Kp)(e))),this._startTime=e,this.setMaterialParameters({startTime:e})}get endTime(){return this._endTime}set endTime(e){this._endTime=e,this.setMaterialParameters({endTime:e})}get query(){return this._query}hasFadedOut(e){return this.endTime+this._material.parameters.fadeOutTime<e}setMaterialParameters(e){this._material.setParameters(e)}get test(){return null}}var W=i(442),U=i(59752);class B extends G{constructor(e,t,i,r,n){super(e,t,i,r,E.Fq.LINE_ROUND.draped.bytesPerFeature),this._layerView=n,this._drapeRenderer=null,this.drapeSourceType=2,this.updatePolicy=0,this.renderGroup=0,this._frameTask=null,this._renderGeometries=[]}get _view(){return this._layerView.view}get layer(){return this._layerView.layer}get fullOpacity(){return this._layerView.fullOpacity}get attached(){return null!=this._drapeRenderer}get destroyed(){return this.attached}async attach(){const{geometries:e}=this;null!=e&&(this.detach(),this._frameTask=this._view.resourceController.scheduler.registerTask(U.W6.FLOW_GENERATOR),await this._frameTask.scheduleGenerator(t=>this._addGeometryToOverlay(e,t)))}_addGeometryToOverlay(e,t){var i=this;return(0,Z.A)(function*(){i._drapeRenderer=i._view.overlayManager.registerGeometryDrapeSource(i);for(let r=0;r<e.length;r+=M.ti){const n=e.slice(r,r+M.ti).map(e=>new W.$(e));i._drapeRenderer.addGeometries(n,0),i._renderGeometries.push(...n),i._drapeRenderer.commitChanges(),t.madeProgress(),t.done&&(t=yield)}})()}detach(){this._frameTask=(0,s.xt)(this._frameTask),this._drapeRenderer&&(this._drapeRenderer.removeGeometries(this._renderGeometries,2),this._drapeRenderer.commitChanges(),this._renderGeometries.length=0),this.attached&&this._view.overlayManager.unregisterDrapeSource(this),this._drapeRenderer=(0,s.pR)(this._drapeRenderer)}}var j=i(37046),N=i(8918);class z extends G{constructor(e,t,i,r,n){super(e,t,i,r,E.Fq.LINE_ROUND.bytesPerFeature),this._view=n,this._objects3D=[],this._engineLayer=null,this._frameTask=null}get attached(){return null!=this._engineLayer}async attach(){const{geometries:e}=this;null!=e&&(this.detach(),this._frameTask=this._view.resourceController.scheduler.registerTask(U.W6.FLOW_GENERATOR),await this._frameTask.scheduleGenerator(t=>this._addGeometryToLayer(e,t)))}detach(){var e,t;this.attached&&(null!==(e=this._engineLayer)&&void 0!==e&&e.removeMany(this._objects3D),this._objects3D.forEach(e=>e.dispose()),null!==(t=this._engineLayer)&&void 0!==t&&t.commit(),this._objects3D=[],this._engineLayer=null,this._frameTask=(0,s.xt)(this._frameTask))}_addGeometryToLayer(e,t){var i=this;return(0,Z.A)(function*(){const{stage:r}=i._view,n=new N.x(r,{pickable:!1,updatePolicy:1});for(let a=0;a<e.length;a+=M.ti){const r=new j.B({geometries:e.slice(a,a+M.ti),castShadow:!1});n.add(r),i._objects3D.push(r),n.commit(),t.madeProgress(),t.done&&(t=yield)}i._engineLayer=n})()}}var H=i(9902),K=i(12028),$=i(52479),Q=i(90992);let Y=class extends w.A{constructor(e){super(e),this.type="flow",this.renderedTiles=null,this.requireLoad=!1,this.workerHandle=null,this.frameTask=null,this._averageLoadingTime=(0,d.Kp)(0),this._abortController=null,this._loadingState="ready-to-load",this._tilesUpdateIsWaiting=!1,this._debugAllowAutoLoading=!0,this.emissiveStrength=0,this._overrideMaterialParameters=null,this._overrideSimulationSettings=null,this._overrideTransitionEnabled=null,this._updateTask=null,this._debouncedTileUpdate=(0,l.sg)(async()=>{const{allTiles:e}=this.surface,t=this._getTileFilterFunction(),i=new Set;await this.frameTask.scheduleGenerator(function*(r){for(let n=0;n<e.length;++n){const a=e.at(n);t(a)&&i.add(a),r.madeProgress(),r.done&&(r=yield)}}),this.renderedTiles=i})}initialize(){const{surface:e,view:t}=this,{resourceController:i}=t;this.workerHandle=new b((0,T.m)(i)),this.frameTask=i.scheduler.registerTask(U.W6.FLOW_GENERATOR),this._updateTask=(0,u.mg)({update:e=>this._update(e)}),this.addHandles([(0,o.wB)(()=>this._simulationSettings,()=>this.triggerLoad(),{sync:!0,equals:(e,t)=>null==e&&null==t||null!=e&&null!=t&&(0,_.r$)(e,t)}),(0,o.wB)(()=>{const{elevationInfo:e}=this;return[this._clippingArea,this._visible,this._draped,this.view.state.contentPixelRatio,this.view.viewingMode,null===e||void 0===e?void 0:e.mode,null===e||void 0===e?void 0:e.offset,null===e||void 0===e?void 0:e.unit,this._effectiveDensity]},()=>this.triggerLoad(),o.OH),(0,o.wB)(()=>this._materialParameters,e=>{var t,i;null!==(t=this._resources)&&void 0!==t&&t.setMaterialParameters(e),null===(i=this._lastResources)||void 0===i||i.setMaterialParameters(e)}),e.on("tiles-changed",()=>{this.loadByTileTreesAllowed&&this._triggerTilesUpdate()}),t.enableFeatureTiles(),(0,o.wB)(()=>[this._dataBounds,this._featureTilesBounds,this.loadAllTiles],()=>this._triggerTilesUpdate()),(0,o.wB)(()=>this._flowRenderer,(e,t)=>{var i,r;const n=null!==(i=null===t||void 0===t?void 0:t.visualVariables)&&void 0!==i?i:[],a=null!==(r=null===e||void 0===e?void 0:e.visualVariables)&&void 0!==r?r:[];a.length===n.length&&a.every((e,t)=>e.type===n[t].type)||this.clear()}),(0,o.z7)(()=>{var e;return!(null!==(e=t.featureTiles)&&void 0!==e&&e.updating)},()=>{this.loadByTileTreesAllowed&&this._triggerTilesUpdate()})]),this._triggerTilesUpdate()}destroy(){this._updateTask=(0,s.xt)(this._updateTask),this.abort(),this.clear()}abort(){this._abortController=(0,s.DC)(this._abortController),this.requireLoad=!1}get _clippingArea(){const e=(0,m.projectOrLoad)(this.view.clippingArea,this.surface.spatialReference).geometry;return null==e?null:(0,p.VY)(e)}get _dataBounds(){const e=(0,m.projectOrLoad)(this.layer.fullExtent,this.surface.spatialReference).geometry;return null==e?null:(0,p.VY)(e)}get _draped(){return"on-the-ground"===this.elevationInfo.mode}get _ellipsoidRadius(){return(0,g.tO)(this.view.spatialReference).radius}get extent(){const{spatialReference:e}=this.surface;let t=this.renderedTiles;if(null==e||null==t)return null;const i=this.view.terrainLevel;if(null!=i){const e=new Set;t.forEach(t=>{Math.abs(i-t.level)<M.iM&&e.add(t)}),t=e}const r=(0,D.DW)(t,this.spatialReferenceInfo);return null==r?null:((0,p.E$)(r,this._clippingArea,r),(0,p.w1)(r,e))}get loadAllTiles(){const{position:e}=this.view.camera,t=e.z;return null!=t&&t*(0,c.G9)(e.spatialReference)/this._ellipsoidRadius>=M.FO}get isDataGlobal(){const{extent:e,spatialReferenceInfo:t}=this;return null!=e&&(0,x.iE)(e.xmin,e.xmax,t)}get loadByTileTreesAllowed(){return!this.loadAllTiles||!this.loadRequirementsMet}get _featureTilesBounds(){var e;const t=null===(e=this.view.featureTiles)||void 0===e?void 0:e.filterExtent,i=(0,m.projectOrLoad)(t,this.surface.spatialReference).geometry;return null==i?null:(0,p.VY)(i)}get _flowRenderer(){const e=this.layer.renderer;return"flow"!==(null===e||void 0===e?void 0:e.type)?null:e}get _materialParameters(){return(0,r.A)((0,r.A)((0,r.A)({},function(e,t,i){var r,n,a,s;if(null==e)return{};let l=null;if(e.visualVariables){const t=[],i=e.visualVariables,r=new L.wI({supports:{size:!0,color:!0,rotation:!1,opacity:!0}});l=(0,L.T3)(i,r,t)}const o=null!==(r=l)&&void 0!==r&&r.color?[1,1,1,1]:A.A.toUnitRGBA(e.color);return o[3]*=t,{color:o,width:e.trailWidth,cap:0,animationSpeed:e.flowSpeed,trailLength:e.trailLength,animation:3,emissiveStrength:i,vvColor:null===(n=l)||void 0===n?void 0:n.color,vvOpacity:null===(a=l)||void 0===a?void 0:a.opacity,vvSize:null===(s=l)||void 0===s?void 0:s.size}}(this._flowRenderer,this.layerView.fullOpacity,this.emissiveStrength)),{},{fadeInTime:M.jt,fadeOutTime:M.um},this._overrideMaterialParameters),{},{hasSlicePlane:this.layerView.slicePlaneEnabled,screenSizePerspective:!this._draped&&(0,K.tl)(this.layer.screenSizePerspectiveEnabled)?this.view.screenSizePerspective.parameters:null})}get _opacity(){return this.layerView.fullOpacity}get _seamlessTransitionWaitingTime(){const{_averageLoadingTime:e}=this;return(0,d.Kp)(0===e?M.$7:this._averageLoadingTime*M.nD)}get _seamlessTransitionEnabled(){return null!=this._overrideTransitionEnabled?this._overrideTransitionEnabled:M.q7}get _tracingResolution(){var e;const{extent:t}=this;if(!t)return[0,0];const i=(0,x.Wn)(t.xmin,t.xmax,null===(e=this.spatialReferenceInfo)||void 0===e?void 0:e.valid)/(t.ymax-t.ymin),[r,n]=this.view.size;let a,s;r<n?(a=r,s=r/i):(a=n*i,s=n);const l=M.NK,o=this.view.qualitySettings.flow3D.maxTracingResolution,u=Math.max(1,l/Math.min(a,s)),d=u*Math.min(1,o/Math.max(a*u,s*u));return[Math.round(a*d),Math.round(s*d)]}get _visible(){var e;const t=null===(e=this._flowRenderer)||void 0===e?void 0:e.color;return this.visibleAtCurrentScale&&this.layer.effectiveVisible&&this._opacity>0&&(null==t||t.a>0)}get _estimatedStreamlines(){const{extent:e,_simulationSettings:t,renderedTiles:i}=this;if(null==t||null==i)return 0;const r=this._tracingResolution[0]*this._tracingResolution[1]/t.lineSpacing**2*t.density,n=null==e?null:(0,p.VY)(e);if(null==n)return 0;let a=0;for(const o of i)(0,p.gR)(n,o.extent)&&(a+=(0,p.Wc)(o.extent));const s=(0,p.Wc)(n),l=0===s?0:a/s;return 2*Math.round(r*l)}get _effectiveDensity(){const{_estimatedStreamlines:e,_simulationSettings:t}=this,{qualitySettings:i,quality:r}=this.view;if(null==t)return 0;const n=i.flow3D.maxTotalNumberOfStreamlines,a=e>=n?n/e:1,s=t.density*a*r;return t.lineSpacing/Math.sqrt(s)<t.lineCollisionWidth?(t.lineSpacing/t.lineCollisionWidth)**2:s}get elevationInfo(){var e;return null!==(e=this.layer.elevationInfo)&&void 0!==e?e:J}startPositions(e){if(!this._seamlessTransitionEnabled)return[];const{_flowRenderer:t,_resources:i}=this;return null==t||null==i?[]:(0,_.Dt)(i.streamlines,i.query,e,t.flowSpeed)}get needsMagnitude(){var e,t;return null!==(e=null===(t=this._flowRenderer)||void 0===t?void 0:t.hasVisualVariables())&&void 0!==e&&e}get spatialReferenceInfo(){return(0,v.Vp)(this.surface.spatialReference)}get layer(){return this.layerView.layer}get loadingState(){return this._loadingState}get loadRequirementsMet(){return null!=this.renderedTiles&&this.renderedTiles.size>0}getUpdating(){return this.updatingHandles.updating||this.requireLoad||"before-transition"===this._loadingState}get updating(){return this.getUpdating()}get visibleAtCurrentScale(){return!(0,Q.j)()||(0,Q.E5)(this.layer.effectiveScaleRange,this.view.scale)}get _simulationSettings(){const{_flowRenderer:e,_overrideSimulationSettings:t}=this;if(null==e)return null;let i=(0,_.hq)(e);return i.segmentLength=i.lineCollisionWidth/2,i.onlyForwardTracing=!1,i.density*=M.Ci,this.loadAllTiles&&this.isDataGlobal&&(i.density*=M.Cq),null!=t&&(i=(0,r.A)((0,r.A)({},i),t)),i}getSimulationSettings(e){const{_simulationSettings:t,spatialReferenceInfo:i}=this;if(null==t)return null;const n="global"===this.view.viewingMode&&null!=i&&(0,x.iE)(e.extent.xmin,e.extent.xmax,i);return(0,r.A)((0,r.A)({},t),{},{wrapAround:n,density:this._effectiveDensity})}get surface(){return this.view.basemapTerrain}doRefresh(){this.triggerLoad()}clear(){var e,t;null!==(e=this._resources)&&void 0!==e&&e.detach(),this._resources=null,null!==(t=this._lastResources)&&void 0!==t&&t.detach(),this._lastResources=null,this._loadingState="ready-to-load"}_update(e){var t;const i=(0,d.y)(e.time);(null===(t=this._lastResources)||void 0===t?void 0:t.hasFadedOut(i))&&this._lastResources.detach();const r=this._nextStateForTransition(i);if(!this.requireLoad||this.updatingHandles.updating||"ready-to-load"!==r||!this.loadRequirementsMet)return void(this._loadingState=r);this._loadingState="loading";this.updatingHandles.addPromise((0,l.QZ)((async()=>{const e=performance.now(),t=this._seamlessTransitionEnabled&&null!=this._resources?(0,d.Kp)(i+this._seamlessTransitionWaitingTime):i;await this._load(t);const r=(0,d.Kp)((performance.now()-e)/1e3);this._updateAverageLoadingTime(r)})())),this.requireLoad=!1}_updateAverageLoadingTime(e){const t=M.S$;this._averageLoadingTime=(0,d.Kp)(t*e+(1-t)*this._averageLoadingTime)}triggerLoad(){this._debugAllowAutoLoading&&(this.requireLoad=!0)}async _load(e){const{extent:t,view:i}=this;if(!this._visible)return this.clear(),void(this._loadingState="ready-to-load");if(null==t)return void(this._loadingState="ready-to-load");const r=new x.y6(t,this.layerView.timeExtent,this._tracingResolution,i.state.contentPixelRatio,e);null==this._abortController&&(this._abortController=new AbortController);const n=this._abortController,a=await this._loadStreamlines(r,n.signal);if((0,l.Te)(n.signal),this._visible&&null!=a){var s;null!==(s=this._lastResources)&&void 0!==s&&s.detach(),this._lastResources=this._resources,this._resources=a;const t=performance.now()/1e3,i=t>e?t:e;null!=this._lastResources&&(this._lastResources.endTime=i),this._resources.startTime=i,await a.attach(),this._loadingState=this._seamlessTransitionEnabled?"before-transition":"transitioning"}else this._loadingState="ready-to-load"}async _loadStreamlines(e,t){const i=await this.fetchDataAndGenerateStreamlines(e,t);if(null==i)return null;const{geometries:r,material:n}=await this._createGeometry(e,i);return this._draped?new B(e,i,n,r,this.layerView):new z(e,i,n,r,this.view)}async fetchDataAndGenerateStreamlines(e,t){return null}async _createGeometry(e,t){const i=new $.W(this._materialParameters,this.view.state.isGlobal),r=new Array,{elevationInfo:n,_draped:a,view:s}=this;return await this.frameTask.scheduleGenerator(function*(l){for(let o=0;o<t.length;++o)r.push(F(s,e,t[o],n,i,a)),l.madeProgress(),l.done&&(l=yield)}),{geometries:r,material:i}}_triggerTilesUpdate(){if(this._tilesUpdateIsWaiting)return;this._tilesUpdateIsWaiting=!0;this.updatingHandles.addPromise((0,l.QZ)((async()=>{await(0,o.C_)(()=>this.view.stationary),this._tilesUpdateIsWaiting=!1,await this._debouncedTileUpdate()})()))}_getTileFilterFunction(){const{_dataBounds:e,view:t,_featureTilesBounds:i}=this;if(this.loadAllTiles)return t=>t.leaf&&X(e,t.extent);const r=t=>t.rendered&&t.visible&&X(e,t.extent),{featureTiles:n}=t;if(!n)return r;const s=n.tiles.filter(e=>e.measures.visible);return e=>r(e)&&X(i,e.extent)&&s.some(t=>{let{lij:i}=t;return(0,a.aI)(i,e.lij)||(0,H.ZH)(i,e.lij)})}_nextStateForTransition(e){const{_resources:t}=this;if(null==this._flowRenderer||null==t||"ready-to-load"===this._loadingState||"loading"===this._loadingState)return this._loadingState;const i=t.startTime;return e<i?"before-transition":e<i+M.um?"transitioning":"ready-to-load"}get usedMemory(){var e,t,i,r;return(null!==(e=null===(t=this._lastResources)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0)+(null!==(i=null===(r=this._resources)||void 0===r?void 0:r.usedMemory)&&void 0!==i?i:0)}get test(){}};(0,n.Cg)([(0,h.MZ)()],Y.prototype,"type",void 0),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"renderedTiles",void 0),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_resources",void 0),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_lastResources",void 0),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"requireLoad",void 0),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_averageLoadingTime",void 0),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_loadingState",void 0),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"emissiveStrength",void 0),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_clippingArea",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_dataBounds",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_draped",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_ellipsoidRadius",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"extent",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"loadAllTiles",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"isDataGlobal",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_featureTilesBounds",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_flowRenderer",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_materialParameters",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_opacity",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_seamlessTransitionWaitingTime",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_seamlessTransitionEnabled",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_tracingResolution",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_visible",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_estimatedStreamlines",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_effectiveDensity",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"elevationInfo",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"needsMagnitude",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"spatialReferenceInfo",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"layer",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"loadingState",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"updating",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"visibleAtCurrentScale",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_overrideMaterialParameters",void 0),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_overrideSimulationSettings",void 0),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_overrideTransitionEnabled",void 0),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"_simulationSettings",null),(0,n.Cg)([(0,h.MZ)()],Y.prototype,"surface",null),Y=(0,n.Cg)([(0,f.$)("esri.views.3d.layers.FlowSubView3D")],Y);const J=new y.A({mode:"on-the-ground"});function X(e,t){return null==e||null==t||(0,p.HY)(e,t)}}}]);
//# sourceMappingURL=33956.4336d74b.chunk.js.map